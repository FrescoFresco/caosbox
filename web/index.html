<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"
    />
    <title>CaosBox • beta</title>

    <!-- IMPORTANTE: placeholder para que flutter lo reemplace en build -->
    <base href="$FLUTTER_BASE_HREF">

    <!-- No metas service worker ni PWA aquí; lo desactivamos en el build -->

    <!-- Cargador moderno de Flutter -->
    <script src="flutter.js" defer></script>

    <style>
      /* Pantalla de fondo blanca mientras arranca */
      html, body { height: 100%; margin: 0; background: #ffffff; }
    </style>
  </head>
  <body>
    <noscript>
      Necesitas habilitar JavaScript para ejecutar esta app.
    </noscript>

    <script>
      // Arranque con el loader moderno
      window.addEventListener('load', async () => {
        try {
          if (!window.__flutter || !window.__flutter.loader) {
            // Mensaje visible si algo va mal
            const pre = document.createElement('pre');
            pre.style = 'white-space:pre-wrap;color:#0f0;background:#000;padding:16px';
            pre.textContent =
              'ERROR: __flutter.loader no está disponible.\n' +
              'Asegúrate de que flutter.js se haya cargado y de NO usar FlutterLoader.* (antiguo).';
            document.body.appendChild(pre);
            return;
          }

          const engineInitializer = await window.__flutter.loader.loadEntrypoint({
            // Sin service worker (pwa-strategy=none en el build)
          });

          const appRunner = await engineInitializer.initializeEngine();
          await appRunner.runApp();
        } catch (e) {
          const pre = document.createElement('pre');
          pre.style = 'white-space:pre-wrap;color:#0f0;background:#000;padding:16px';
          pre.textContent =
            '=== CAOSBOX DIAG ===\n' +
            new Date().toISOString() + '\n' +
            (e && e.stack ? e.stack : String(e)) + '\n' +
            'flutter.js presente? ' + !!document.querySelector('script[src$="flutter.js"]') + '\n' +
            'window.__flutter? ' + !!window.__flutter + '\n';
          document.body.appendChild(pre);
          // Re-lanzamos para que lo vea la consola
          throw e;
        }
      });
    </script>
  </body>
</html>
